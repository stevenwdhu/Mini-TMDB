{% extends 'base.html' %} {% block content %}
<div class="container p-3 d-flex flex-column gap-3">
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="m-0">Movie</h2>
    <a
      class="btn btn-primary"
      href="/favourite/download/movie?movie={{ movie_id_list|join(',') }}"
      >Export</a
    >
  </div>
  <div class="d-flex flex-column gap-3">
    {% for movie in movie_list %}
    <a
      class="d-flex rounded-3 bg-secondary-subtle gap-3 p-3 text-decoration-none text-black media-card"
      media-id="{{ movie.id }}"
      media-type="movie"
      href="/movie/{{ movie.id }}"
      onmouseover="this.classList.add('shadow')"
      onmouseleave="this.classList.remove('shadow')"
    >
      <img
        class="h-100 rounded-3"
        src="{{ movie.poster_path }}"
        style="width: 8em"
        alt="{{ movie.title }}"
      />
      <div class="d-flex flex-column">
        <div class="d-flex gap-3 align-items-center">
          <div class="">{{ movie.title }}</div>
          <div
            class="favourite-btn col-1 text-secondary"
            {#onclick="document.querySelector('#navFavourite').click()"
            #}
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-heart d-block"
              viewBox="0 0 16 16"
              onmouseover="this.setAttribute('fill','salmon')"
              onmouseout="this.setAttribute('fill','currentColor')"
            >
              <path
                d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"
              ></path>
            </svg>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="salmon"
              class="bi bi-heart-fill d-none"
              viewBox="0 0 16 16"
            >
              <path
                fill-rule="evenodd"
                d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"
              ></path>
            </svg>
          </div>
        </div>
        <div class="">{{ movie.release_date }}</div>
        <div class="text-secondary" style="font-size: 80%">
          {{ movie.genre_list|join('/') }}
        </div>
        <div>
          <span class="fs-5" style="color: chocolate"
            >{{ "%.2f"|format(movie.vote_average) }}</span
          >
          /10
        </div>
        <div class="text-multi-ellipsis" style="-webkit-line-clamp: 5">
          {{ movie.overview }}
        </div>
      </div>
    </a>
    {% endfor %}
  </div>
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="m-0">TV</h2>
    <a
      class="btn btn-primary"
      href="/favourite/download/tv?tv={{ tv_id_list|join(',') }}"
      >Export</a
    >
  </div>
  <div class="d-flex flex-column gap-3">
    {% for tv in tv_list %}
    <a
      class="d-flex rounded-3 bg-secondary-subtle gap-3 p-3 text-decoration-none text-black media-card"
      media-id="{{ tv.id }}"
      media-type="tv"
      href="/tv/{{ tv.id }}"
      onmouseover="this.classList.add('shadow')"
      onmouseleave="this.classList.remove('shadow')"
    >
      <img
        class="h-100 rounded-3"
        src="{{ tv.poster_path }}"
        style="width: 8em"
        alt="{{ tv.name }}"
      />
      <div class="d-flex flex-column">
        <div class="d-flex gap-3 align-items-center">
          <div class="">{{ tv.name }}</div>
          <div class="favourite-btn col-1 text-secondary">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-heart d-block"
              viewBox="0 0 16 16"
              onmouseover="this.setAttribute('fill','salmon')"
              onmouseout="this.setAttribute('fill','currentColor')"
            >
              <path
                d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"
              ></path>
            </svg>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="salmon"
              class="bi bi-heart-fill d-none"
              viewBox="0 0 16 16"
            >
              <path
                fill-rule="evenodd"
                d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"
              ></path>
            </svg>
          </div>
        </div>
        <div class="">{{ tv.first_air_date }}</div>
        <div class="text-secondary" style="font-size: 80%">
          {{ tv.genre_list|join('/') }}
        </div>
        <div>
          <span class="fs-5" style="color: chocolate"
            >{{ "%.2f"|format(tv.vote_average) }}</span
          >
          /10
        </div>
        <div class="text-multi-ellipsis" style="-webkit-line-clamp: 5">
          {{ tv.overview }}
        </div>
      </div>
    </a>
    {% endfor %}
  </div>
  <div class="d-flex justify-content-around">
    <div style="width: 400px">
      <canvas id="mediaTypeChart"></canvas>
    </div>
    <div style="width: 500px">
      <canvas id="genreChart"></canvas>
    </div>
    <div style="width: 400px">
      <canvas id="yearChart"></canvas>
    </div>
  </div>
</div>
{% endblock %} {% block script %}
<script>
  document.querySelectorAll(".favourite-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      document.querySelector("#navFavourite").click();
    });
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const movieList = ({{ movie_list|map(attribute='__dict__')|list|tojson }})
  const tvList = ({{ tv_list|map(attribute='__dict__')|list|tojson }})
  const genreList = [movieList,tvList].flat().map(media=>media.genres.map(g=>g.name)).flat()
  const genreData = genreList.reduce((prev,curr)=>({...prev, [curr]: (prev[curr] ?? 0) + 1}), {})
  const yearList = [movieList,tvList].flat().map(media=>media.release_date||media.first_air_date).filter(s=>!!s).map(s=>parseInt(s.slice(0,4)))
  const yearData = yearList.reduce((prev,curr)=>({...prev, [curr]: (prev[curr] ?? 0) + 1}), {})

  new Chart(document.getElementById("mediaTypeChart"), {
      type: "pie",
      data: {
          labels: ["Movie", "TV"],
          datasets: [
              {
                  data: [movieIdList.length, tvIdList.length],
              },
          ],
      },
      options: {
          maintainAspectRatio:false,
          responsive: true,
          plugins: {
              title: {
                  display: true,
                  text: "Media Type",
              },
              legend:{
                  position:'left'
              },
              tooltips:{
                  enabled:false
              }
          },
      },
  });
  new Chart(document.getElementById("genreChart"), {
    type: "pie",
    data: {
      labels: Object.keys(genreData),
      datasets: [
        {
          data: Object.values(genreData),
        },
      ],
    },
    options: {
        maintainAspectRatio:false,
        responsive: true,
      plugins: {
        title: {
          display: true,
          text: "Genres",
        },
          legend:{
            position:'left'
          }
      },
    },
  });
  new Chart(document.getElementById("yearChart"), {
      type: "bar",
      data: {
          labels: Object.keys(yearData).sort(),
          datasets: [
              {

                  label: '',
                  data: Object.keys(yearData).sort().map(y=>yearData[y]),
              },
          ],
      },
      options: {
          maintainAspectRatio:false,
          responsive: true,
          plugins: {
              title: {
                  display: true,
                  text: "Years",
              },
              legend:{
                  display: false
              }
          },
          scales:{
              y: {

                  beginAtZero:true
              }
          }
      },
  });
</script>
{% endblock %}
